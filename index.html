<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="utf-8" />
  <title>ប្លង់បណ្តាញទុយោទឹកស្អាតខេត្តកំពង់ស្ពឺ ឆ្នាំ២០២៥ ដល់ ឆ្នាំ២០២៤០</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- Sidebar CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar-v2/css/leaflet-sidebar.min.css" />
  <!-- Search CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-search/dist/leaflet-search.min.css" />

  <style>
    body { margin:0; padding:0; font-family:"Khmer OS","Noto Sans Khmer",sans-serif; }
    #header { background:#005cbf; color:white; padding:16px; text-align:center; font-size:22px; font-weight:bold; }
    #map { position:absolute; top:64px; bottom:0; right:0; left:0; }
    .leaflet-sidebar-content { padding:10px; }
    .layer-checkbox { margin:6px 0; }
  </style>
</head>
<body>
  <div id="header">ប្លង់បណ្តាញទុយោទឹកស្អាតខេត្តកំពង់ស្ពឺ ឆ្នាំ២០២៥ ដល់ ឆ្នាំ២០២៤០</div>

  <!-- Sidebar container -->
  <div id="sidebar" class="leaflet-sidebar collapsed">
    <div class="leaflet-sidebar-tabs">
      <ul role="tablist">
        <li><a href="#layers" role="tab"><i class="fa fa-list"></i></a></li>
        <li><a href="#searchpane" role="tab"><i class="fa fa-search"></i></a></li>
      </ul>
    </div>
    <div class="leaflet-sidebar-content">
      <div class="leaflet-sidebar-pane" id="layers">
        <h1 class="leaflet-sidebar-header">ស្រទាប់បង្ហាញ<button class="leaflet-sidebar-close"><i class="fa fa-chevron-right"></i></button></h1>
        <div id="layer-list"></div>
      </div>
      <div class="leaflet-sidebar-pane" id="searchpane">
        <h1 class="leaflet-sidebar-header">ស្វែងរក<button class="leaflet-sidebar-close"><i class="fa fa-chevron-right"></i></button></h1>
        <div id="search-control"></div>
      </div>
    </div>
  </div>

  <div id="map"></div>

  <!-- JS Dependencies -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-sidebar-v2/js/leaflet-sidebar.min.js"></script>
  <script src="https://unpkg.com/leaflet-search/dist/leaflet-search.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

  <script>
    // Initialize map
    var map = L.map('map').setView([11.4, 104.5], 10);
    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'© OSM' }).addTo(map);
    var esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom:19, attribution:'© Esri' });
    L.control.layers({ 'Street': osm, 'Satellite': esri }).addTo(map);

    // Create sidebar
    var sidebar = L.control.sidebar({ container:'sidebar', autopan:true }).addTo(map);
    sidebar.open('layers');

    // Define layers
    var existingLayer = L.geoJSON(null, {
      style: { color: 'black', weight: 2 },
      onEachFeature: function(feature, layer) {
        layer.bindPopup(
          '<strong>Pipe Code:</strong> ' + (feature.properties.pipe_code || 'N/A') + '<br>' +
          '<strong>Length:</strong> ' + (feature.properties.length || 'N/A') + ' m<br>' +
          '<strong>Diameter:</strong> ' + (feature.properties.diameter || 'N/A') + ' mm<br>' +
          '<strong>Elevation:</strong> ' + (feature.properties.elevation || 'N/A') + ' m<br>' +
          '<strong>Village:</strong> ' + (feature.properties.village || 'N/A')
        );
      }
    }).addTo(map);
    var newLayer = L.geoJSON(null, {
      style: { color: 'white', weight: 2 },
      onEachFeature: function(feature, layer) {
        layer.bindPopup(
          '<strong>Pipe Code:</strong> ' + (feature.properties.pipe_code || 'N/A') + '<br>' +
          '<strong>Length:</strong> ' + (feature.properties.length || 'N/A') + ' m<br>' +
          '<strong>Diameter:</strong> New Pipe<br>' +
          '<strong>Elevation:</strong> ' + (feature.properties.elevation || 'N/A') + ' m<br>' +
          '<strong>Village:</strong> ' + (feature.properties.village || 'N/A')
        );
      }
    }).addTo(map);
    var wsLayer = L.geoJSON(null, {
      pointToLayer: function(feature, latlng) {
        return L.circleMarker(latlng, { radius:6, fillColor:'#3498db', color:'#2980b9', weight:1, fillOpacity:0.8 });
      },
      onEachFeature: function(feature, layer) {
        var props = feature.properties || {};
        var popup = '<table>';
        for (var key in props) popup += '<tr><th>'+ key +'</th><td>'+ props[key] +'</td></tr>';
        popup += '</table>';
        layer.bindPopup(popup);
      }
    }).addTo(map);
    var wtpLayer = L.geoJSON(null, {
      pointToLayer: function(feature, latlng) {
        return L.circleMarker(latlng, { radius:6, fillColor:'#f1c40f', color:'#d4ac0d', weight:1, fillOpacity:0.8 });
      },
      onEachFeature: function(feature, layer) {
        var props = feature.properties || {};
        var popup = '<table>';
        for (var key in props) popup += '<tr><th>'+ key +'</th><td>'+ props[key] +'</td></tr>';
        popup += '</table>';
        layer.bindPopup(popup);
      }
    }).addTo(map);

    // Sidebar layer list
    var overlays = {
      'បណ្តាញទុយោបច្ចុប្បន្ន': existingLayer,
      'បណ្តាញទុយោពង្រីក៖ ថ្ងៃអនាគត': newLayer,
      'ស្ថានីយ WS': wsLayer,
      'ស្ថានីយ WTP': wtpLayer
    };
    var layerList = document.getElementById('layer-list');
    Object.keys(overlays).forEach(function(name){
      var div = document.createElement('div'); div.className='layer-checkbox';
      var input = document.createElement('input'); input.type='checkbox'; input.checked=true; input.id=name;
      input.onchange = function(){ this.checked ? map.addLayer(overlays[name]) : map.removeLayer(overlays[name]); };
      var label = document.createElement('label'); label.htmlFor=name; label.innerText=name;
      div.appendChild(input); div.appendChild(label);
      layerList.appendChild(div);
    });

    // GitHub loader
    var githubUser='YOUR_USERNAME', githubRepo='YOUR_REPO', githubBranch='main';
    if(githubUser==='YOUR_USERNAME') githubUser=window.location.host.split('.')[0];
    if(githubRepo==='YOUR_REPO'){ var parts=window.location.pathname.split('/').filter(Boolean); if(parts.length) githubRepo=parts[0]; }
    fetch(`https://api.github.com/repos/${githubUser}/${githubRepo}/contents?ref=${githubBranch}`)
      .then(res=>res.json())
      .then(files=> files.filter(f=>f.type==='file'&&/\.(geojson?|json)$/i.test(f.name))
        .forEach(f=> fetch(`https://raw.githubusercontent.com/${githubUser}/${githubRepo}/${githubBranch}/${f.name}`)
          .then(r=>r.json()).then(data=>{
            data.features.forEach(feat=>{
              var t=feat.geometry.type;
              if(t.includes('Line')){ feat.properties.diameter ? existingLayer.addData(feat) : newLayer.addData(feat); }
              else if(t==='Point'){ var n=feat.properties.name||''; n.includes('WS') ? wsLayer.addData(feat) : n.includes('WTP') ? wtpLayer.addData(feat) : null; }
            });
          }).catch(e=>console.error('load error',f.name,e))
        )
      ).catch(e=>console.error('repo list error',e));

    // Search
    var allPoints = L.featureGroup([wsLayer, wtpLayer]);
    var searchControl = new L.Control.Search({ layer: allPoints, propertyName:'name', marker:false, moveToLocation:function(latlng){ map.setView(latlng,14); } });
    map.addControl(searchControl);
    document.getElementById('search-control').appendChild(searchControl.getContainer());
  </script>
</body>
</html>
