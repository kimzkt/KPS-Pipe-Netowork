<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="utf-8" />
  <title>ប្លង់បណ្តាញទុយោទឹកស្អាតខេត្តកំពង់ស្ពឺ ២០២៥–២០២៤០</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSS Dependencies -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar-v2/css/leaflet-sidebar.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-search/dist/leaflet-search.min.css" />
  <style>
    body { margin:0; padding:0; font-family:"Khmer OS","Noto Sans Khmer",sans-serif; }
    #header { background:#005cbf; color:#fff; padding:12px; text-align:center; font-size:20px; }
    #map { position:absolute; top:48px; bottom:0; left:0; right:0; }
    .leaflet-sidebar { width:260px !important; }
    .leaflet-sidebar-tabs a { width:50px; height:50px; line-height:50px; }
    .leaflet-sidebar-content { padding:8px; font-size:14px; }
    .leaflet-sidebar-header { font-size:16px; margin-bottom:8px; }
    .layer-checkbox { margin:4px 0; }
    #search-control .leaflet-search-wrap { display:flex; width:100% !important; }
    #search-control .leaflet-search-input { flex:1; padding:6px; font-size:16px; }
    #search-control .leaflet-search-button { margin-left:-32px; width:24px; height:24px; background:none; border:none; }
    .legend { position:absolute; bottom:20px; right:10px; background:#fff; padding:8px; font-size:14px; border-radius:4px; box-shadow:0 0 6px rgba(0,0,0,0.3); width:260px; }
    .legend-item { display:flex; align-items:center; margin-bottom:6px; white-space:nowrap; }
    .legend-item:last-child { margin-bottom:0; }
    .legend i { width:18px; height:18px; margin-right:8px; border:1px solid #000; }
    .legend i.circle { border-radius:50%; }
    .leaflet-control-scale-denominator { background:#fff; padding:4px 6px; font-size:12px; border:1px solid rgba(0,0,0,0.2); border-radius:4px; }
  </style>
</head>
<body>
  <div id="header">ប្លង់បណ្តាញទុយោទឹកស្អាតខេត្តកំពង់ស្ពឺ ២០២៥–២០២៤០</div>
  <div id="sidebar" class="leaflet-sidebar collapsed">
    <div class="leaflet-sidebar-tabs"><ul role="tablist">
      <li><a href="#layers" role="tab"><i class="fa fa-list"></i></a></li>
      <li><a href="#searchpane" role="tab"><i class="fa fa-search"></i></a></li>
    </ul></div>
    <div class="leaflet-sidebar-content">
      <div id="layers" class="leaflet-sidebar-pane">
        <h1 class="leaflet-sidebar-header">ស្រទាប់<button class="leaflet-sidebar-close"><i class="fa fa-chevron-right"></i></button></h1>
        <div id="layer-list"></div>
      </div>
      <div id="searchpane" class="leaflet-sidebar-pane">
        <h1 class="leaflet-sidebar-header">ស្វែងរក<button class="leaflet-sidebar-close"><i class="fa fa-chevron-right"></i></button></h1>
        <div id="search-control"></div>
      </div>
    </div>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-sidebar-v2/js/leaflet-sidebar.min.js"></script>
  <script src="https://unpkg.com/leaflet-search/dist/leaflet-search.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  <script>
    var map = L.map('map').setView([11.4,104.5],10);
    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OSM',maxZoom:19}).addTo(map);
    var esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'© Esri',maxZoom:19});
    L.control.layers({'Street':osm,'Satellite':esri}).addTo(map);

    // scale and denominator
    L.control.scale({position:'bottomleft',metric:true,imperial:false}).addTo(map);
    var ScaleDen = L.Control.extend({options:{position:'bottomleft'},onAdd:function(m){this._div=L.DomUtil.create('div','leaflet-control-scale-denominator');m.on('zoomend moveend',this._upd,this);this._upd();return this._div;},_upd:function(){var lat=map.getCenter().lat, z=map.getZoom();var mpp=156543.0339*Math.cos(lat*Math.PI/180)/Math.pow(2,z);var scale=mpp*96/0.0254;this._div.innerHTML='ទំហំ៖ 1:'+Math.round(scale).toLocaleString();}});
    L.control.scaleDen = function(opts){return new ScaleDen(opts);} ;
    L.control.scaleDen({position:'bottomleft'}).addTo(map);

    var sidebar = L.control.sidebar({container:'sidebar',autopan:true}).addTo(map);
    sidebar.open('layers');

    // define layers
    var existingLayer = L.geoJSON(null,{style:{color:'black',weight:2},onEachFeature:function(f,l){l.bindPopup('Pipe:'+f.properties.pipe_code);} }).addTo(map);
    var newLayer      = L.geoJSON(null,{style:{color:'white',weight:2},onEachFeature:function(f,l){l.bindPopup('Pipe:'+f.properties.pipe_code);} }).addTo(map);
    var wsLayer       = L.geoJSON(null,{pointToLayer:function(f,latlng){return L.circleMarker(latlng,{radius:6,fillColor:'#3498db',color:'#2980b9',fillOpacity:0.8});},onEachFeature:function(f,l){var p=f.properties||{};var h='<table>';for(var k in p){h+='<tr><th>'+k+'</th><td>'+p[k]+'</td></tr>';}h+='</table>';l.bindPopup(h);}}).addTo(map);
    var wtpLayer      = L.geoJSON(null,{pointToLayer:function(f,latlng){return L.circleMarker(latlng,{radius:6,fillColor:'#f1c40f',color:'#d4ac0d',fillOpacity:0.8});},onEachFeature:function(f,l){var p=f.properties||{};var h='<table>';for(var k in p){h+='<tr><th>'+k+'</th><td>'+p[k]+'</td></tr>';}h+='</table>';l.bindPopup(h);}}).addTo(map);
    var polygonLayer  = L.geoJSON(null,{style:{color:'#888',weight:1,fillOpacity:0.3},onEachFeature:function(f,l){var p=f.properties||{};var h='<table>';for(var k in p){h+='<tr><th>'+k+'</th><td>'+p[k]+'</td></tr>';}h+='</table>';l.bindPopup(h);}}).addTo(map);

    // toggles
    var overlays = {'Existing Pipes':existingLayer,'New Pipes':newLayer,'WS Stations':wsLayer,'WTP Stations':wtpLayer,'Polygons':polygonLayer};
    Object.keys(overlays).forEach(function(name){
      var div=document.createElement('div');div.className='layer-checkbox';
      var inp=document.createElement('input');inp.type='checkbox';inp.checked=true;inp.id=name;
      inp.onchange=function(){this.checked?map.addLayer(overlays[name]):map.removeLayer(overlays[name]);};
      var lbl=document.createElement('label');lbl.htmlFor=name;lbl.innerText=name;
      div.appendChild(inp);div.appendChild(lbl);
      document.getElementById('layer-list').appendChild(div);
    });

    // load JSON from GitHub
    var user='YOUR_USERNAME', repo='YOUR_REPO', branch='main';
    if(user==='YOUR_USERNAME') user=window.location.host.split('.')[0];
    if(repo==='YOUR_REPO'){var parts=window.location.pathname.split('/').filter(Boolean);if(parts.length)repo=parts[0];}
    fetch(`https://api.github.com/repos/${user}/${repo}/contents?ref=${branch}`)
      .then(r=>r.json())
      .then(files=>files.filter(f=>f.type==='file'&&/\.(geojson?|json)$/i.test(f.name)).forEach(f=>{
        fetch(`https://raw.githubusercontent.com/${user}/${repo}/${branch}/${f.name}`)
          .then(r=>r.json()).then(data=>{
            var feats=[];
            if(data.type==='FeatureCollection'&&Array.isArray(data.features)) feats=data.features;
            else if(Array.isArray(data)) feats=data;
            else for(var k in data)if(Array.isArray(data[k])){feats=data[k];break;}
            feats.forEach(feat=>{
              var gt=feat.geometry&&feat.geometry.type;
              if(gt&&gt.includes('Line')){
                feat.properties&&feat.properties.diameter?existingLayer.addData(feat):newLayer.addData(feat);
              } else if(gt==='Point'){
                var nm=feat.properties&&feat.properties.name||'';
                if(nm.includes('WS')) wsLayer.addData(feat);
                else if(nm.includes('WTP')) wtpLayer.addData(feat);
              } else if(gt==='Polygon'||gt==='MultiPolygon'){
                polygonLayer.addData(feat);
              }
            });
          });
      }));

    // search
    var allPts=L.featureGroup([wsLayer,wtpLayer,polygonLayer]);
    var searchCtl=new L.Control.Search({layer:allPts,propertyName:'name',marker:false,moveToLocation:function(latlng){map.setView(latlng,14);}});
    map.addControl(searchCtl);
    document.getElementById('search-control').appendChild(searchCtl.getContainer());

    // legend
    var legend=L.control({position:'bottomright'});
    legend.onAdd=function(){var d=L.DomUtil.create('div','legend');d.innerHTML=
      '<div class="legend-item"><i style="background:black"></i> បណ្តាញទុយោបច្ចុប្បន្ន</div>'+
      '<div class="legend-item"><i style="background:white"></i> បណ្តាញទុយោពង្រីក</div>'+
      '<div class="legend-item"><i class="circle" style="background:#3498db"></i> ស្ថានីយ WS</div>'+
      '<div class="legend-item"><i class="circle" style="background:#f1c40f"></i> ស្ថានីយ WTP</div>'+
      '<div class="legend-item"><i style="background:#888"></i> លំនាំ Polygon</div>';
      return d;};
    legend.addTo(map);
  </script>
</body>
</html>
