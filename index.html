<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="utf-8" />
  <title>ផែនទីការផ្គត់ផ្គង់ទឹកស្អាតនៅកម្ពុជា ២០២៥–២០២៤០</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar-v2/css/leaflet-sidebar.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-search/dist/leaflet-search.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    body { margin:0; padding:0; font-family:"Khmer OS","Noto Sans Khmer",sans-serif; }
    #header { background:#005cbf; color:#fff; padding:12px; text-align:center; font-size:20px; }
    #map { position:absolute; top:48px; bottom:0; left:0; right:0; }
    .leaflet-sidebar { width:260px !important; }
    .leaflet-sidebar.collapsed { width:50px !important; }
    .leaflet-sidebar-tabs a { width:50px; height:50px; line-height:50px; }
    .leaflet-sidebar-content { padding:8px; font-size:14px; }
    .leaflet-sidebar-header { font-size:16px; margin-bottom:8px; }

    /* Layer and Base Map sections in sidebar */
    .sidebar-section { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
    .sidebar-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .sidebar-section-title { font-weight: bold; margin-bottom: 8px; font-size: 15px; color: #333; }

    .layer-checkbox, .base-map-radio { margin:4px 0; display: flex; align-items: center; }
    .layer-checkbox input[type="checkbox"],
    .base-map-radio input[type="radio"] { margin-right: 8px; }

    /* Search Control Styles (now directly on map) */
    .leaflet-control-search {
        position: absolute;
        top: 10px; /* Adjust as needed */
        left: 10px; /* Adjust as needed */
        z-index: 999;
        background: #fff;
        border-radius: 4px;
        box-shadow: 0 1px 5px rgba(0,0,0,0.4);
        padding: 5px;
        display: flex;
        align-items: center;
        width: 250px; /* Fixed width for the search bar */
    }

    .leaflet-control-search .search-input {
        flex-grow: 1;
        border: none;
        padding: 6px;
        font-size: 16px;
        outline: none;
    }

    .leaflet-control-search .search-button {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 18px;
        padding: 0 5px;
        color: #555;
        outline: none;
    }
    .leaflet-control-search .search-button:hover {
        color: #000;
    }

    /* Dynamic Compass Styles */
    .leaflet-control-compass {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 50%;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        cursor: pointer;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        border: 2px solid #ccc;
    }

    .leaflet-control-compass:hover {
        background: rgba(255, 255, 255, 1);
        box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        transform: scale(1.05);
    }

    .compass-arrow {
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-bottom: 20px solid #d32f2f;
        position: relative;
        transition: transform 0.3s ease;
        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
    }

    .compass-arrow::after {
        content: '';
        position: absolute;
        top: 20px;
        left: -6px;
        width: 0;
        height: 0;
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-top: 15px solid #666;
    }

    .compass-n {
        position: absolute;
        top: 5px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 12px;
        font-weight: bold;
        color: #d32f2f;
        text-shadow: 0 1px 2px rgba(255,255,255,0.8);
    }

    .legend { position:absolute; bottom:20px; right:10px; background:#fff; padding:8px; font-size:14px; border-radius:4px; box-shadow:0 0 6px rgba(0,0,0,0.3); width:260px; }
    .legend-title { font-weight: bold; text-align: center; margin-bottom: 8px; font-size: 16px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px; }
    .legend-item { display:flex; align-items:center; margin-bottom:6px; white-space:nowrap; }
    .legend-item:last-child { margin-bottom:0; }
    .legend i { width:18px; height:18px; margin-right:8px; border:1px solid #000; }
    .legend i.circle { border-radius:50%; }
    .leaflet-control-scale-denominator { background:#fff; padding:4px 6px; font-size:12px; border:1px solid rgba(0,0,0,0.2); border-radius:4px; margin-top:4px; }

    /* Loading Spinner Styles */
    #loading-spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        display: none; /* Hidden by default */
        background: rgba(255, 255, 255, 0.8);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.2);
        text-align: center;
    }
    #loading-spinner .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 2s linear infinite;
        margin: 0 auto 10px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Popup table styling for better readability */
    .leaflet-popup-content table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        margin-top: 5px;
    }
    .leaflet-popup-content table th,
    .leaflet-popup-content table td {
        padding: 4px 6px;
        border-bottom: 1px solid #eee;
        text-align: left;
    }
    .leaflet-popup-content table th {
        font-weight: bold;
        white-space: nowrap;
    }
    .leaflet-popup-content table tr:last-child th,
    .leaflet-popup-content table tr:last-child td {
        border-bottom: none;
    }

    /* Removed custom L.Control.Layers toggle styling as base layers are now in sidebar */
    .leaflet-control-layers-toggle {
        display: none !important; /* Hide the default Leaflet layers toggle */
    }

    /* Responsive adjustments for smaller screens (e.g., mobile) */
    @media (max-width: 768px) {
        #header { font-size: 18px; padding: 10px; }
        #map { top: 44px; } /* Adjust map top if header height changes */

        /* Sidebar: Takes more width when open, fixed tab width when collapsed */
        .leaflet-sidebar { width: 80vw !important; }
        .leaflet-sidebar.collapsed { width: 50px !important; }
        .leaflet-sidebar-tabs a { width:50px; height:50px; line-height:50px; }

        /* Search Control: Adjust width to be more flexible */
        .leaflet-control-search {
            width: calc(100vw - 60px); /* Fill most of the screen width, considering margins */
            left: 10px;
            right: 10px;
            max-width: 300px; /* Prevent it from getting too wide on slightly larger mobiles */
        }
        .leaflet-control-search .search-input {
            font-size: 14px; /* Smaller font for search input */
        }

        /* Legend: Adjust width to be more flexible */
        .legend {
            width: calc(100% - 20px);
            max-width: 280px;
            right: 10px;
            bottom: 10px;
            font-size: 13px;
        }

        /* Adjust positions of other controls if they conflict */
        .leaflet-control-zoom { top: 60px !important; right: 10px !important; }
        .leaflet-top.leaflet-right { top: 60px !important; right: 10px !important; } /* For locate control */
        .leaflet-bottom.leaflet-left { margin-left: 10px !important; margin-bottom: 10px !important; } /* For scale control, ensure it's not hidden by sidebar */
        
        /* Compass adjustments for mobile */
        .leaflet-control-compass {
            width: 50px;
            height: 50px;
        }
        .compass-arrow {
            border-left-width: 6px;
            border-right-width: 6px;
            border-bottom-width: 16px;
        }
        .compass-arrow::after {
            left: -4px;
            border-left-width: 4px;
            border-right-width: 4px;
            border-top-width: 12px;
        }
    }

  </style>
</head>
<body>
  <div id="header">ផែនទីការផ្គត់ផ្គង់ទឹកស្អាតនៅកម្ពុជា ២០២៥–២០២៤០</div>
  <div id="sidebar" class="leaflet-sidebar collapsed">
    <div class="leaflet-sidebar-tabs">
      <ul role="tablist">
        <li><a href="#layers" role="tab"><i class="fa fa-list"></i></a></li>
        </ul>
    </div>
    <div class="leaflet-sidebar-content">
      <div id="layers" class="leaflet-sidebar-pane">
        <h1 class="leaflet-sidebar-header">ស្រទាប់ និង ផែនទីមូលដ្ឋាន<button class="leaflet-sidebar-close"><i class="fa fa-chevron-right"></i></button></h1>
        <div class="sidebar-section">
            <div class="sidebar-section-title">ស្រទាប់</div>
            <div id="layer-list"></div>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-section-title">ផែនទីមូលដ្ឋាន</div>
            <div id="base-map-list"></div>
        </div>
      </div>
      </div>
  </div>
  <div id="map"></div>
  <div id="loading-spinner">
    <div class="spinner"></div>
    <div>កំពុងផ្ទុកទិន្នន័យ...</div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-sidebar-v2/js/leaflet-sidebar.min.js"></script>
  <script src="https://unpkg.com/leaflet-search/dist/leaflet-search.min.js"></script>
  <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  <script>
    // Configuration Object
    const config = {
        mapCenter: [11.4, 104.5],
        initialZoom: 10,
        github: {
            username: 'YOUR_GITHUB_USERNAME', // <--- REPLACE THIS WITH YOUR GITHUB USERNAME
            repo: 'YOUR_GITHUB_REPO_NAME',    // <--- REPLACE THIS WITH YOUR GITHUB REPOSITORY NAME
            branch: 'main'
        },
        layerStyles: {
            existingPipe: { color: '#444', weight: 2 },
            newPipe: { color: 'white', weight: 2 },
            waterSource: { radius: 6, fillColor: '#3498db', color: '#2980b9', fillOpacity: 0.8, weight: 1 },
            waterTreatmentPlant: { radius: 6, fillColor: '#f1c40f', color: '#d4ac0d', fillOpacity: 0.8, weight: 1 },
            countryBoundary: {
                color: '#ff0000', // Red border
                weight: 2,
                fillOpacity: 0
            }
        },
        attribution: {
            osm: '© OpenStreetMap contributors',
            esri: '© Esri, Maxar, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community'
        },
    };

    // Global map variables
    let map;
    let sidebar;
    let existingLayer, newLayer, wsLayer, wtpLayer, countryBoundaryLayer;
    let allPointFeatures;
    let currentBaseLayer; // To keep track of the active base layer
    let compassControl; // To keep track of the compass control

    const baseLayersConfig = {
        'Street': {
            layer: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: config.attribution.osm,
                maxZoom: 19
            }),
            default: true // Set Street as default
        },
        'Satellite': {
            layer: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: config.attribution.esri,
                maxZoom: 19
            })
        }
        // Add more base maps here if needed, e.g., 'Terrain', 'Light', 'Dark'
        // 'Terrain': { layer: L.tileLayer('YOUR_TERRAIN_TILE_URL', { attribution: 'YOUR_ATTRIBUTION' }) },
        // 'Light': { layer: L.tileLayer('YOUR_LIGHT_TILE_URL', { attribution: 'YOUR_ATTRIBUTION' }) },
        // 'Dark': { layer: L.tileLayer('YOUR_DARK_TILE_URL', { attribution: 'YOUR_ATTRIBUTION' }) }
    };

    /**
     * Shows the loading spinner.
     */
    function showLoadingSpinner() {
        document.getElementById('loading-spinner').style.display = 'block';
    }

    /**
     * Hides the loading spinner.
     */
    function hideLoadingSpinner() {
        document.getElementById('loading-spinner').style.display = 'none';
    }

    /**
     * Dynamic Compass Control for Leaflet
     */
    L.Control.Compass = L.Control.extend({
        options: {
            position: 'topright'
        },

        onAdd: function(map) {
            const container = L.DomUtil.create('div', 'leaflet-control-compass');
            container.title = 'Click to reset north orientation';
            
            // Create compass elements
            const compassN = L.DomUtil.create('div', 'compass-n', container);
            compassN.innerHTML = 'N';
            
            const arrow = L.DomUtil.create('div', 'compass-arrow', container);
            
            this._container = container;
            this._arrow = arrow;
            
            // Click event to reset bearing
            L.DomEvent.on(container, 'click', this._resetBearing, this);
            L.DomEvent.disableClickPropagation(container);
            
            // Update compass when map rotates
            map.on('rotate', this._updateCompass, this);
            map.on('moveend', this._updateCompass, this);
            
            // Initial update
            this._updateCompass();
            
            return container;
        },

        onRemove: function(map) {
            map.off('rotate', this._updateCompass, this);
            map.off('moveend', this._updateCompass, this);
        },

        _updateCompass: function() {
            const map = this._map;
            let bearing = 0;
            
            // Check if map has rotation capability (like with leaflet-rotate plugin)
            if (map.getBearing && typeof map.getBearing === 'function') {
                bearing = map.getBearing();
            } else if (map.options && map.options.rotate) {
                bearing = map.options.rotate;
            }
            
            // Rotate the arrow to show north direction
            this._arrow.style.transform = `rotate(${-bearing}deg)`;
            
            // Update container opacity based on rotation
            if (Math.abs(bearing) < 1) {
                this._container.style.opacity = '0.7';
            } else {
                this._container.style.opacity = '1';
            }
        },

        _resetBearing: function() {
            const map = this._map;
            
            // Reset bearing if map supports rotation
            if (map.setBearing && typeof map.setBearing === 'function') {
                map.setBearing(0);
            } else if (map.setRotation && typeof map.setRotation === 'function') {
                map.setRotation(0);
            }
            
            // Visual feedback
            this._container.style.transform = 'scale(0.9)';
            setTimeout(() => {
                this._container.style.transform = 'scale(1)';
            }, 150);
        }
    });

    // Factory function for the compass control
    L.control.compass = function(options) {
        return new L.Control.Compass(options);
    };

    /**
     * Initializes the Leaflet map and base layers.
     */
    function initializeMap() {
        map = L.map('map', { zoomControl: false }).setView(config.mapCenter, config.initialZoom);

        // Add the default base layer to the map
        for (const key in baseLayersConfig) {
            if (baseLayersConfig[key].default) {
                currentBaseLayer = baseLayersConfig[key].layer.addTo(map);
                break;
            }
        }

        // Hide the default Leaflet layers toggle, as base maps are now in sidebar
        const layersToggle = document.querySelector('.leaflet-control-layers-toggle');
        if (layersToggle) {
            layersToggle.style.display = 'none';
        }
    }

    /**
     * Adds various controls to the map.
     */
    function addMapControls() {
        L.control.zoom({ position: 'topright' }).addTo(map);

        // Add the dynamic compass control
        compassControl = L.control.compass({ position: 'topright' }).addTo(map);

        // Standard Leaflet Scale Control
        L.control.scale({ position: 'bottomleft', metric: true, imperial: false }).addTo(map);

        // Custom Scale Denominator Control (placed just below the standard scale)
        const ScaleDen = L.Control.extend({
            options: { position: 'bottomleft' },
            onAdd: function(mapInstance) {
                this._div = L.DomUtil.create('div', 'leaflet-control-scale-denominator');
                mapInstance.on('zoomend moveend', this._updateScaleDenominator, this);
                this._updateScaleDenominator();
                return this._div;
            },
            _updateScaleDenominator: function() {
                const lat = map.getCenter().lat;
                const z = map.getZoom();
                const mpp = 156543.0339 * Math.cos(lat * Math.PI / 180) / Math.pow(2, z);
                const scale = mpp * 96 / 0.0254;
                this._div.innerHTML = 'មាត្រដ្ឋាន៖ 1:' + Math.round(scale).toLocaleString();
            }
        });
        L.control.scaleDenominator = (opts) => new ScaleDen(opts);
        L.control.scaleDenominator({ position: 'bottomleft' }).addTo(map);

        L.control.locate({
            position: 'topright',
            strings: { title: 'ស្វែងរកទីតាំង​របស់ខ្ញុំ' },
            drawCircle: true,
            follow: true,
            setView: 'untilPan',
            markerStyle: {
                fillColor: '#1a73e8',
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            },
            circleStyle: {
                color: '#1a73e8',
                fillColor: '#1a73e8',
                fillOpacity: 0.1,
                weight: 1
            }
        }).addTo(map);
    }

    /**
     * Sets up the sidebar.
     */
    function setupSidebar() {
        sidebar = L.control.sidebar({ container: 'sidebar', autopan: true }).addTo(map);

        // Open sidebar on larger screens, keep collapsed on smaller screens
        if (window.innerWidth > 768) {
            sidebar.open('layers');
        }
    }

    /**
     * Creates and adds GeoJSON layers to the map.
     */
    function createGeoJSONLayers() {
        // New layer for country boundary (added first so it's at the bottom)
        countryBoundaryLayer = L.geoJSON(null, {
            style: config.layerStyles.countryBoundary,
            interactive: false, // Make it non-interactive to allow clicks on layers above
            onEachFeature: (feature, layer) => {
                // No popup for non-interactive layer
            }
        });

        existingLayer = L.geoJSON(null, {
            style: config.layerStyles.existingPipe,
            onEachFeature: (feature, layer) => {
                const pipeCode = feature.properties.pipe_code || 'N/A';
                const diameter = feature.properties.diameter ? ` (${feature.properties.diameter}mm)` : '';
                const material = feature.properties.material ? `<br>Material: ${feature.properties.material}` : '';
                layer.bindPopup(`<b>Pipe Code:</b> ${pipeCode}${diameter}${material}`);
            }
        });

        newLayer = L.geoJSON(null, {
            style: config.layerStyles.newPipe,
            onEachFeature: (feature, layer) => {
                const pipeCode = feature.properties.pipe_code || 'N/A';
                const diameter = feature.properties.diameter ? ` (${feature.properties.diameter}mm)` : '';
                const material = feature.properties.material ? `<br>Material: ${feature.properties.material}` : '';
                layer.bindPopup(`<b>Pipe Code:</b> ${pipeCode}${diameter}${material}`);
            }
        });

        wsLayer = L.geoJSON(null, {
            pointToLayer: (feature, latlng) => L.circleMarker(latlng, config.layerStyles.waterSource),
            onEachFeature: (feature, layer) => {
                const properties = feature.properties || {};
                let html = '';
                const name = properties.name || 'Unnamed Water Source';
                if (name) {
                    html += `<b>${name}</b><br>`;
                }

                html += '<table>';
                for (const key in properties) {
                    if (properties.hasOwnProperty(key) && typeof properties[key] !== 'object' && key !== 'name') {
                        html += `<tr><th>${key}</th><td>${properties[key]}</td></tr>`;
                    }
                }
                html += '</table>';
                layer.bindPopup(html);
            }
        });

        wtpLayer = L.geoJSON(null, {
            pointToLayer: (feature, latlng) => L.circleMarker(latlng, config.layerStyles.waterTreatmentPlant),
            onEachFeature: (feature, layer) => {
                const properties = feature.properties || {};
                let html = '';
                const name = properties.name || 'Unnamed Water Treatment Plant';
                if (name) {
                    html += `<b>${name}</b><br>`;
                }

                html += '<table>';
                for (const key in properties) {
                     if (properties.hasOwnProperty(key) && typeof properties[key] !== 'object' && key !== 'name') {
                        html += `<tr><th>${key}</th><td>${properties[key]}</td></tr>`;
                    }
                }
                html += '</table>';
                layer.bindPopup(html);
            }
        });


        // Add layers to map in desired order (country boundary at the very bottom)
        countryBoundaryLayer.addTo(map);
        existingLayer.addTo(map);
        newLayer.addTo(map);
        wsLayer.addTo(map);
        wtpLayer.addTo(map);
    }

    /**
     * Populates the layer list (overlays and base maps) in the sidebar.
     */
    function populateLayerList() {
        const overlays = {
            'បណ្តាញទុយោបច្ចុប្បន្ន': existingLayer,
            'បណ្តាញទុយោពង្រីក': newLayer,
            'ទីតាំងប្រភពទឹក': wsLayer,
            'ទីតាំងស្ថានីយទឹកស្អាត': wtpLayer,
            'ព្រំដែនប្រទេស': countryBoundaryLayer
        };

        const layerListDiv = document.getElementById('layer-list');
        Object.keys(overlays).forEach(name => {
            const div = document.createElement('div');
            div.className = 'layer-checkbox';

            const input = document.createElement('input');
            input.type = 'checkbox';
            input.checked = true; // All overlay layers checked by default
            input.id = `overlay-${name.replace(/\s/g, '-')}`;
            input.onchange = () => {
                if (input.checked) {
                    map.addLayer(overlays[name]);
                } else {
                    map.removeLayer(overlays[name]);
                }
            };

            const label = document.createElement('label');
            label.htmlFor = input.id;
            label.innerText = name;

            div.appendChild(input);
            div.appendChild(label);
            layerListDiv.appendChild(div);
        });

        const baseMapListDiv = document.getElementById('base-map-list');
        Object.keys(baseLayersConfig).forEach(name => {
            const div = document.createElement('div');
            div.className = 'base-map-radio';

            const input = document.createElement('input');
            input.type = 'radio';
            input.name = 'base-map'; // All base map radios should have the same name
            input.id = `base-${name.replace(/\s/g, '-')}`;
            input.checked = baseLayersConfig[name].default || false; // Set default base map as checked

            input.onchange = () => {
                if (map.hasLayer(currentBaseLayer)) {
                    map.removeLayer(currentBaseLayer);
                }
                currentBaseLayer = baseLayersConfig[name].layer.addTo(map);
            };

            const label = document.createElement('label');
            label.htmlFor = input.id;
            label.innerText = name;

            div.appendChild(input);
            div.appendChild(label);
            baseMapListDiv.appendChild(div);
        });
    }


    /**
     * Loads GeoJSON data from GitHub.
     * @returns {Promise<void>}
     */
    async function loadGeojsonData() {
        showLoadingSpinner();
        const { username, repo, branch } = config.github;
        let effectiveUser = username;
        let effectiveRepo = repo;

        // Auto-infer GitHub user/repo if placeholders are used, for gh-pages or local testing
        if (username === 'YOUR_GITHUB_USERNAME' || repo === 'YOUR_GITHUB_REPO_NAME') {
            try {
                const urlPathParts = location.pathname.split('/').filter(Boolean);
                if (location.host.includes('github.io')) {
                     effectiveUser = location.host.split('.')[0];
                     if (urlPathParts.length > 0) {
                         effectiveRepo = urlPathParts[0];
                     } else {
                         effectiveRepo = effectiveUser;
                     }
                } else if (urlPathParts.length >= 2) {
                    effectiveUser = urlPathParts[0];
                    effectiveRepo = urlPathParts[1];
                }
            } catch (e) {
                console.warn("Could not infer GitHub user/
