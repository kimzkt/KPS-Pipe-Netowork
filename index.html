<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="utf-8" />
  <title>ប្លង់បណ្តាញទុយោទឹកស្អាតខេត្តកំពង់ស្ពឺ ឆ្នាំ២០២៥ ដល់ ឆ្នាំ២០២៤០</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- Sidebar CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar-v2/css/leaflet-sidebar.min.css" />
  <!-- Search CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-search/dist/leaflet-search.min.css" />

  <style>
    body { margin:0; padding:0; font-family:"Khmer OS","Noto Sans Khmer",sans-serif; }
    #header { background:#005cbf; color:white; padding:16px; text-align:center; font-size:22px; font-weight:bold; }
    #map { position:absolute; top:64px; bottom:0; right:0; left:0; }

    /* Sidebar */
    .leaflet-sidebar { width:260px !important; }
    .leaflet-sidebar.collapsed { width:50px !important; }
    .leaflet-sidebar-tabs a { width:50px; height:50px; line-height:50px; }
    .leaflet-sidebar-content { padding:10px; font-size:14px; }
    .leaflet-sidebar-header { font-size:16px; margin-bottom:8px; }
    .layer-checkbox label { font-size:14px; }

    /* Search input */
    #search-control .leaflet-search-wrap { display:flex; width:100% !important; margin-bottom:10px; }
    #search-control .leaflet-search-input { flex:1; padding:6px 10px; font-size:16px; border-radius:4px; border:1px solid #ccc; }
    #search-control .leaflet-search-button { margin-left:-35px !important; width:30px; height:30px; background:none; border:none; }

    /* Legend */
    .legend { position:absolute; bottom:20px; right:10px; background:white; padding:10px 12px; font-size:14px; border-radius:5px; box-shadow:0 0 6px rgba(0,0,0,0.3); width:260px; }
    .legend .legend-item { display:flex; align-items:center; margin-bottom:8px; white-space:nowrap; }
    .legend .legend-item:last-child { margin-bottom:0; }
    .legend i { width:18px; height:18px; margin-right:8px; display:inline-block; border:1px solid #000; flex-shrink:0; }
    .legend i.circle { border-radius:50%; }
  </style>
</head>
<body>
  <div id="header">ប្លង់បណ្តាញទុយោទឹកស្អាតខេត្តកំពង់ស្ពឺ ឆ្នាំ២០២៥ដល់ឆ្នាំ២០៤០</div>

  <!-- Sidebar container -->
  <div id="sidebar" class="leaflet-sidebar collapsed">
    <div class="leaflet-sidebar-tabs">
      <ul role="tablist">
        <li><a href="#layers" role="tab"><i class="fa fa-list"></i></a></li>
        <li><a href="#searchpane" role="tab"><i class="fa fa-search"></i></a></li>
      </ul>
    </div>
    <div class="leaflet-sidebar-content">
      <div class="leaflet-sidebar-pane" id="layers">
        <h1 class="leaflet-sidebar-header">ស្រទាប់បង្ហាញ<button class="leaflet-sidebar-close"><i class="fa fa-chevron-right"></i></button></h1>
        <div id="layer-list"></div>
      </div>
      <div class="leaflet-sidebar-pane" id="searchpane">
        <h1 class="leaflet-sidebar-header">ស្វែងរក<button class="leaflet-sidebar-close"><i class="fa fa-chevron-right"></i></button></h1>
        <div id="search-control"></div>
      </div>
    </div>
  </div>

  <div id="map"></div>

  <!-- JS Dependencies -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-sidebar-v2/js/leaflet-sidebar.min.js"></script>
  <script src="https://unpkg.com/leaflet-search/dist/leaflet-search.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

  <script>
    // Initialize map and base layers
    var map = L.map('map').setView([11.4, 104.5], 10);
    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OSM' }).addTo(map);
    var esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: '© Esri' });
    L.control.layers({ 'Street': osm, 'Satellite': esri }).addTo(map);

    // Scale bar
    L.control.scale({ position: 'bottomleft', metric: true, imperial: false }).addTo(map);

    // Sidebar
    var sidebar = L.control.sidebar({ container: 'sidebar', autopan: true }).addTo(map);
    sidebar.open('layers');

    // Pipeline layers
    var existingLayer = L.geoJSON(null, {
      style: { color: 'black', weight: 2 },
      onEachFeature: function(feature, layer) {
        layer.bindPopup(
          '<strong>Pipe Code:</strong> ' + (feature.properties.pipe_code || 'N/A') + '<br>' +
          '<strong>Length:</strong> ' + (feature.properties.length || 'N/A') + ' m'<
        );
      }
    }).addTo(map);
    var newLayer = L.geoJSON(null, {
      style: { color: 'white', weight: 2 },
      onEachFeature: function(feature, layer) {
        layer.bindPopup(
          '<strong>Pipe Code:</strong> ' + (feature.properties.pipe_code || 'N/A') + '<br>' +
          '<strong>Length:</strong> ' + (feature.properties.length || 'N/A') + ' m'
        );
      }
    }).addTo(map);

    // Point layers
    var wsLayer = L.geoJSON(null, {
      pointToLayer: function(feature, latlng) {
        return L.circleMarker(latlng, { radius: 6, fillColor: '#3498db', color: '#2980b9', weight: 1, fillOpacity: 0.8 });
      },
      onEachFeature: function(feature, layer) {
        var props = feature.properties || {};
        var popup = '<table>';
        for (var key in props) popup += '<tr><th>' + key + '</th><td>' + props[key] + '</td></tr>';
        popup += '</table>';
        layer.bindPopup(popup);
      }
    }).addTo(map);
    var wtpLayer = L.geoJSON(null, {
      pointToLayer: function(feature, latlng) {
        return L.circleMarker(latlng, { radius: 6, fillColor: '#f1c40f', color: '#d4ac0d', weight: 1, fillOpacity: 0.8 });
      },
      onEachFeature: function(feature, layer) {
        var props = feature.properties || {};
        var popup = '<table>';
        for (var key in props) popup += '<tr><th>' + key + '</th><td>' + props[key] + '</td></tr>';
        popup += '</table>';
        layer.bindPopup(popup);
      }
    }).addTo(map);

    // Layer toggles
    var overlays = {
      'Existing Pipes': existingLayer,
      'New Pipes': newLayer,
      'WS Stations': wsLayer,
      'WTP Stations': wtpLayer
    };
    Object.keys(overlays).forEach(function(name) {
      var div = document.createElement('div');
      div.className = 'layer-checkbox';
      var checkbox = document.createElement('input');
      checkbox.type = 'checkbox'; checkbox.checked = true; checkbox.id = name;
      checkbox.onchange = function() {
        this.checked ? map.addLayer(overlays[name]) : map.removeLayer(overlays[name]);
      };
      var label = document.createElement('label');
      label.htmlFor = name; label.innerText = name;
      div.appendChild(checkbox); div.appendChild(label);
      document.getElementById('layer-list').appendChild(div);
    });

    // Load all JSON/GeoJSON from GitHub root
    var user = 'YOUR_USERNAME', repo = 'YOUR_REPO', branch = 'main';
    if (user === 'YOUR_USERNAME') user = window.location.host.split('.')[0];
    if (repo === 'YOUR_REPO') {
      var parts = window.location.pathname.split('/').filter(Boolean);
      if (parts.length) repo = parts[0];
    }
    fetch(`https://api.github.com/repos/${user}/${repo}/contents?ref=${branch}`)
      .then(res => res.json())
      .then(files => {
        files.filter(f => f.type === 'file' && /\.(geojson?|json)$/i.test(f.name))
             .forEach(f => {
               fetch(`https://raw.githubusercontent.com/${user}/${repo}/${branch}/${f.name}`)
                 .then(r => r.json())
                 .then(data => {
                   var feats = [];
                   if (data.type === 'FeatureCollection' && Array.isArray(data.features)) feats = data.features;
                   else if (Array.isArray(data)) feats = data;
                   else for (var key in data) if (Array.isArray(data[key])) { feats = data[key]; break; }
                   feats.forEach(function(feat) {
                     var geom = feat.geometry && feat.geometry.type;
                     if (geom && geom.includes('Line')) {
                       feat.properties && feat.properties.diameter ? existingLayer.addData(feat) : newLayer.addData(feat);
                     } else if (geom === 'Point') {
                       var nameVal = feat.properties && feat.properties.name || '';
                       if (nameVal.includes('WS')) wsLayer.addData(feat);
                       else if (nameVal.includes('WTP')) wtpLayer.addData(feat);
                     }
                   });
                 });
             });
      });

    // Search control
    var allPoints = L.featureGroup([wsLayer, wtpLayer]);
    var searchControl = new L.Control.Search({ layer: allPoints, propertyName: 'name', marker: false, moveToLocation: function(latlng) { map.setView(latlng, 14); } });
    map.addControl(searchControl);
    document.getElementById('search-control').appendChild(searchControl.getContainer());

    // Legend
    var legend = L.control({ position: 'bottomright' });
    legend.onAdd = function() {
      var div = L.DomUtil.create('div', 'legend');
      div.innerHTML =
        '<div class="legend-item"><i style="background:black"></i> ជីវិត Pipe (Existing)</div>' +
        '<div class="legend-item"><i style="background:white"></i> ថ្មី Pipe (New)</div>' +
        '<div class="legend-item"><i class="circle" style="background:#3498db"></i> WS Stations</div>' +
        '<div class="legend-item"><i class="circle" style="background:#f1c40f"></i> WTP Stations</div>';
      return div;
    };
    legend.addTo(map);
  </script>
</body>
</html>
