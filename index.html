<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="utf-8" />
  <title>ប្លង់បណ្តាញទុយោទឹកស្អាតខេត្តកំពង់ស្ពឺ ២០២៥–២០២៤០</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSS Dependencies -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar-v2/css/leaflet-sidebar.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-search/dist/leaflet-search.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
  <style>
    body { margin:0; padding:0; font-family:"Khmer OS","Noto Sans Khmer",sans-serif; }
    #header { 
      background:#005cbf; 
      color:#fff; 
      padding:12px; 
      text-align:center; 
      font-size:20px; 
      position: relative;
      z-index: 1000;
    }
    #map { position:absolute; top:48px; bottom:0; left:0; right:0; }
    .leaflet-sidebar { width:260px !important; }
    .leaflet-sidebar.collapsed { width:50px !important; }
    .leaflet-sidebar-tabs a { width:50px; height:50px; line-height:50px; }
    .leaflet-sidebar-content { padding:8px; font-size:14px; }
    .leaflet-sidebar-header { 
      font-size:16px; 
      margin-bottom:8px; 
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .layer-checkbox { margin:8px 0; display: flex; align-items: center; }
    .layer-checkbox input { margin-right: 8px; }
    #search-control .leaflet-search-wrap { display:flex; width:100% !important; margin-bottom:10px; }
    #search-control .leaflet-search-input { flex:1; padding:6px; font-size:16px; border-radius:4px; }
    .legend { 
      position:absolute; 
      bottom:20px; 
      right:10px; 
      background:rgba(255,255,255,0.9); 
      padding:12px; 
      font-size:14px; 
      border-radius:4px; 
      box-shadow:0 0 8px rgba(0,0,0,0.3); 
      width:280px; 
      z-index: 500;
    }
    .legend-item { display:flex; align-items:center; margin-bottom:8px; }
    .legend-color { 
      width:24px; 
      height:24px; 
      margin-right:10px; 
      border:1px solid #333;
      display: inline-block;
    }
    .legend-color.circle { border-radius:50%; }
    .leaflet-control-scale-denominator { 
      background:rgba(255,255,255,0.8); 
      padding:4px 8px; 
      font-size:13px; 
      border:1px solid rgba(0,0,0,0.2); 
      border-radius:4px; 
      margin-top:4px; 
    }
    .sidebar-close-btn { 
      background: none; 
      border: none; 
      cursor: pointer; 
      font-size: 16px;
      color: #555;
    }
  </style>
</head>
<body>
  <div id="header">ប្លង់បណ្តាញទុយោទឹកស្អាតខេត្តកំពង់ស្ពឺ ២០២៥–២០២៤០</div>
  
  <div id="sidebar" class="leaflet-sidebar">
    <div class="leaflet-sidebar-tabs"><ul role="tablist">
      <li><a href="#layers" role="tab"><i class="fas fa-layer-group"></i></a></li>
      <li><a href="#searchpane" role="tab"><i class="fas fa-search"></i></a></li>
    </ul></div>
    <div class="leaflet-sidebar-content">
      <div id="layers" class="leaflet-sidebar-pane">
        <h1 class="leaflet-sidebar-header">
          ស្រទាប់
          <button class="sidebar-close-btn"><i class="fas fa-times"></i></button>
        </h1>
        <div id="layer-list"></div>
      </div>
      <div id="searchpane" class="leaflet-sidebar-pane">
        <h1 class="leaflet-sidebar-header">
          ស្វែងរក
          <button class="sidebar-close-btn"><i class="fas fa-times"></i></button>
        </h1>
        <div id="search-control"></div>
      </div>
    </div>
  </div>
  
  <div id="map"></div>
  
  <div class="legend">
    <h3 style="margin-top:0; border-bottom:1px solid #ddd; padding-bottom:5px;">សញ្ញាណ</h3>
    <div class="legend-item">
      <span class="legend-color" style="background:black;"></span> បណ្តាញទុយោបច្ចុប្បន្ន
    </div>
    <div class="legend-item">
      <span class="legend-color" style="background:white;"></span> បណ្តាញទុយោពង្រីក
    </div>
    <div class="legend-item">
      <span class="legend-color circle" style="background:#3498db;"></span> ទីតាំងប្រភពទឹក
    </div>
    <div class="legend-item">
      <span class="legend-color circle" style="background:#f1c40f;"></span> ទីតាំងស្ថានីយទឹកស្អាត
    </div>
  </div>

  <!-- JS Dependencies -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-sidebar-v2/js/leaflet-sidebar.min.js"></script>
  <script src="https://unpkg.com/leaflet-search/dist/leaflet-search.min.js"></script>
  <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  
  <script>
    (async function() {
      // Initialize map
      var map = L.map('map', {
        zoomControl: false,
        attributionControl: false
      }).setView([11.4, 104.5], 10);
      
      // Add base layers
      var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        maxZoom: 19
      }).addTo(map);
      
      var esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '&copy; Esri',
        maxZoom: 19
      });
      
      // Layer control
      var baseLayers = {
        'ផែនទីផ្លូវ': osm,
        'ផែនទីផ្កាយ': esri
      };
      L.control.layers(baseLayers).addTo(map);
      
      // Map controls
      L.control.zoom({ position: 'topright' }).addTo(map);
      L.control.scale({ position: 'bottomleft', metric: true, imperial: false }).addTo(map);
      
      // Custom scale denominator control
      var ScaleDen = L.Control.extend({
        options: { position: 'bottomleft' },
        onAdd: function(map) {
          this._div = L.DomUtil.create('div', 'leaflet-control-scale-denominator');
          map.on('zoomend moveend', this._update, this);
          this._update();
          return this._div;
        },
        _update: function() {
          var lat = map.getCenter().lat;
          var z = map.getZoom();
          var mpp = 156543.0339 * Math.cos(lat * Math.PI / 180) / Math.pow(2, z);
          var scale = mpp * 96 / 0.0254;
          this._div.innerHTML = 'ទំហំ៖ 1:' + Math.round(scale).toLocaleString('km');
        }
      });
      new ScaleDen().addTo(map);
      
      // Locate control
      L.control.locate({
        position: 'topright',
        strings: {
          title: 'ស្វែងរកទីតាំង​របស់ខ្ញុំ'
        }
      }).addTo(map);
      
      // Sidebar control
      var sidebar = L.control.sidebar({
        container: 'sidebar',
        autopan: true,
        position: 'left'
      }).addTo(map);
      sidebar.open('layers');
      
      // Layer initialization
      var existingLayer = L.geoJSON(null, {
        style: { color: 'black', weight: 3 },
        onEachFeature: function(feature, layer) {
          var props = feature.properties || {};
          var content = '<div class="popup-content">';
          for (var key in props) {
            content += '<p><strong>' + key + ':</strong> ' + props[key] + '</p>';
          }
          content += '</div>';
          layer.bindPopup(content);
        }
      }).addTo(map);
      
      var newLayer = L.geoJSON(null, {
        style: { color: 'white', weight: 3, dashArray: '5, 10' },
        onEachFeature: function(feature, layer) {
          var props = feature.properties || {};
          var content = '<div class="popup-content">';
          for (var key in props) {
            content += '<p><strong>' + key + ':</strong> ' + props[key] + '</p>';
          }
          content += '</div>';
          layer.bindPopup(content);
        }
      }).addTo(map);
      
      var wsLayer = L.geoJSON(null, {
        pointToLayer: function(feature, latlng) {
          return L.circleMarker(latlng, {
            radius: 8,
            fillColor: '#3498db',
            color: '#2980b9',
            weight: 2,
            fillOpacity: 0.9
          });
        },
        onEachFeature: function(feature, layer) {
          var props = feature.properties || {};
          var content = '<div class="popup-content"><h4>ប្រភពទឹក</h4>';
          for (var key in props) {
            content += '<p><strong>' + key + ':</strong> ' + props[key] + '</p>';
          }
          content += '</div>';
          layer.bindPopup(content);
        }
      }).addTo(map);
      
      var wtpLayer = L.geoJSON(null, {
        pointToLayer: function(feature, latlng) {
          return L.circleMarker(latlng, {
            radius: 8,
            fillColor: '#f1c40f',
            color: '#d4ac0d',
            weight: 2,
            fillOpacity: 0.9
          });
        },
        onEachFeature: function(feature, layer) {
          var props = feature.properties || {};
          var content = '<div class="popup-content"><h4>ស្ថានីយទឹកស្អាត</h4>';
          for (var key in props) {
            content += '<p><strong>' + key + ':</strong> ' + props[key] + '</p>';
          }
          content += '</div>';
          layer.bindPopup(content);
        }
      }).addTo(map);
      
      // Layer control UI
      var overlays = {
        'បណ្តាញទុយោបច្ចុប្បន្ន': existingLayer,
        'បណ្តាញទុយោពង្រីក': newLayer,
        'ទីតាំងប្រភពទឹក': wsLayer,
        'ទីតាំងស្ថានីយទឹកស្អាត': wtpLayer
      };
      
      var layerList = document.getElementById('layer-list');
      Object.keys(overlays).forEach(function(name) {
        var container = document.createElement('div');
        container.className = 'layer-checkbox';
        
        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = true;
        checkbox.id = name.replace(/\s+/g, '-');
        checkbox.onchange = function() {
          if (this.checked) {
            map.addLayer(overlays[name]);
          } else {
            map.removeLayer(overlays[name]);
          }
        };
        
        var label = document.createElement('label');
        label.htmlFor = checkbox.id;
        label.textContent = name;
        
        container.appendChild(checkbox);
        container.appendChild(label);
        layerList.appendChild(container);
      });
      
      // GitHub data loading
      var user = 'YOUR_GITHUB_USERNAME';
      var repo = 'YOUR_REPO_NAME';
      var branch = 'main';
      
      // Auto-detect GitHub Pages URL structure
      if (user === 'YOUR_GITHUB_USERNAME') {
        user = location.host.split('.')[0];
      }
      if (repo === 'YOUR_REPO_NAME') {
        var pathParts = location.pathname.split('/').filter(Boolean);
        repo = pathParts.length > 0 ? pathParts[0] : user;
      }
      
      try {
        // Load repository contents
        var contents = await fetch(`https://api.github.com/repos/${user}/${repo}/contents?ref=${branch}`);
        var files = await contents.json();
        
        // Process GeoJSON files
        for (var file of files) {
          if (file.type === 'file' && /\.geojson$/i.test(file.name)) {
            var response = await fetch(file.download_url);
            var geojson = await response.json();
            
            // Add features to appropriate layers
            geojson.features.forEach(function(feature) {
              if (feature.geometry) {
                switch(feature.geometry.type) {
                  case 'LineString':
                  case 'MultiLineString':
                    if (feature.properties && feature.properties.status === 'existing') {
                      existingLayer.addData(feature);
                    } else {
                      newLayer.addData(feature);
                    }
                    break;
                  case 'Point':
                    if (feature.properties && /ប្រភពទឹក|WS/i.test(feature.properties.name)) {
                      wsLayer.addData(feature);
                    } else if (feature.properties && /ស្ថានីយទឹកស្អាត|WTP/i.test(feature.properties.name)) {
                      wtpLayer.addData(feature);
                    }
                    break;
                }
              }
            });
          }
        }
      } catch (error) {
        console.error('Error loading GeoJSON data:', error);
      }
      
      // Search control
      var allPoints = L.featureGroup([wsLayer, wtpLayer]);
      var searchControl = new L.Control.Search({
        layer: allPoints,
        propertyName: 'name',
        collapsed: false,
        textPlaceholder: 'ស្វែងរកទីតាំង...',
        marker: false,
        moveToLocation: function(latlng, title, map) {
          map.setView(latlng, 15);
        }
      });
      map.addControl(searchControl);
      document.getElementById('search-control').appendChild(searchControl.getContainer());
      
      // Close sidebar buttons
      document.querySelectorAll('.sidebar-close-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          sidebar.close();
        });
      });
    })();
  </script>
</body>
</html>
